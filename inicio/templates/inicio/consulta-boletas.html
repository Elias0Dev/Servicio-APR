{% extends 'inicio/base.html' %}
{% block title %}
<title>Detalle Boletas - Servicio APR</title>
{% endblock %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'inicio/css/style.css' %}">
{% endblock %}

<!-- Codigo que envia el service worker a la web(PWA) -->
{% load pwa %}
{% progressive_web_app_meta %}

{% block contenido %}
<!-- Se envia codigo a la etiqueta <body> -->
<div class="container">
    <h1>Detalle de Boleta</h1>
    
    <div class="search-section">
        <label for="cliente">Número de Cliente:</label>
        <input type="number" id="cliente" placeholder="Ingresa tu número de cliente">
        <button id="buscar">Buscar</button>
    </div>

    <!-- Mensaje de error -->
    <div id="error-message" class="alert alert-danger hidden"></div>

    <!-- Contenedor para el nuevo gráfico de consumo (inicialmente oculto) -->
    <div id="grafico-consumo-container" class="consumo-card hidden">
        <h5 id="consumo-periodo" class="card-title"></h5>
        <p class="text-muted">Tu consumo del último período registrado.</p>
        <div class="text-center my-3">
          <span id="consumo-valor" class="consumo-valor"></span>
          <p id="consumo-limite" class="consumo-limite"></p>
        </div>
        <div class="progress-label">
          <span>Progreso del mes</span>
          <span id="progreso-porcentaje" class="fw-bold"></span>
        </div>
        <div class="progress">
          <div id="progreso-barra" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
    <!-- Fin del contenedor del gráfico -->

    <div id="resultados" class="hidden">
        <h4 id="nombre-cliente-display" class="mt-4 mb-3"></h4> 
        <table id="tabla-boletas" class="table table-hover" border="2">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Consumido (m³)</th>
                    <th scope="col">Fecha de Emisión</th>
                    <th scope="col">Total a Pagar($)</th>
                    <th scope="col">Acción</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla">
                <!-- Las filas se agregarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const buscarBtn = document.getElementById('buscar');
    if(buscarBtn) {
        buscarBtn.addEventListener('click', fetchFacturas);
    }
});

function fetchFacturas() {
    const numeroCliente = document.getElementById('cliente').value;
    const resultadosContainer = document.getElementById('resultados');
    const cuerpoTabla = document.getElementById('cuerpo-tabla');
    const errorMessage = document.getElementById('error-message');
    const graficoContainer = document.getElementById('grafico-consumo-container');
        const nombreClienteDisplay = document.getElementById('nombre-cliente-display');

    // Ocultar todo antes de la nueva búsqueda
    resultadosContainer.classList.add('hidden');
    graficoContainer.classList.add('hidden');
    errorMessage.classList.add('hidden');
    cuerpoTabla.innerHTML = '';

    if (!numeroCliente) {
      errorMessage.textContent = 'Por favor, ingrese un número de cliente.';
      errorMessage.classList.remove('hidden');
      return;
    }

    fetch(`/buscar-facturas/?numero_cliente=${numeroCliente}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Cliente no encontrado o error en la solicitud.');
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.nombre_cliente) {
            nombreClienteDisplay.textContent = `Historial de: ${data.nombre_cliente}`;
        }
        // --- LÓGICA PARA EL NUEVO GRÁFICO ---
        if (data.consumo_reciente) {
          const consumo = data.consumo_reciente;
          document.getElementById('consumo-periodo').textContent = `Consumo de Agua - ${consumo.periodo}`;
          document.getElementById('consumo-valor').innerHTML = `${consumo.consumo} m³`;
          document.getElementById('consumo-limite').textContent = `de ${consumo.limite} m³ disponibles como límite de referencia`;
          
          const barra = document.getElementById('progreso-barra');
          barra.style.width = `${consumo.porcentaje}%`;
          barra.setAttribute('aria-valuenow', consumo.porcentaje);
          
          document.getElementById('progreso-porcentaje').textContent = `${consumo.porcentaje}%`;
          
          graficoContainer.classList.remove('hidden');
        } else {
          graficoContainer.classList.add('hidden');
        }
        // --- FIN DE LA LÓGICA DEL GRÁFICO ---

        // Lógica para la tabla de historial
        if (data.facturas && data.facturas.length > 0) {
          data.facturas.forEach(factura => {
            let row = cuerpoTabla.insertRow();
            row.innerHTML = `
              <td>${factura.consumido}</td>
              <td>${factura.fecha}</td>
              <td>${factura.valor}</td>
              <td>
                <a href="/generar-boleta/${factura.id}/" target="_blank" class="btn btn-sm btn-outline-primary">Ver Boleta</a>
              </td>
            `;
          });
          resultadosContainer.classList.remove('hidden');
        } else {
          errorMessage.textContent = 'No se encontraron boletas para este número de cliente.';
          errorMessage.classList.remove('hidden');
        }
      })
      .catch(error => {
        errorMessage.textContent = error.message;
        errorMessage.classList.remove('hidden');
      });
}
</script>
{% endblock %}
